<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contraseña</title>
    <link rel="stylesheet" href="../CSS/style.css">
</head>
<body>
    <header>
        <h1>Congreso Universitario</h1>
    </header>

    <main class="reset-container">
        <h2>Restablecer contraseña</h2>
        <p>Introduce una nueva contraseña. El enlace tiene un token temporal.</p>

        <form id="reset-form">
            <input type="hidden" id="uid" name="uid" />
            <input type="hidden" id="token" name="token" />

            <div class="form-group">
                <label for="new-password">Nueva contraseña</label>
                <input type="password" id="new-password" name="new_password" required minlength="6">
            </div>

            <div class="form-group">
                <label for="confirm-password">Confirmar nueva contraseña</label>
                <input type="password" id="confirm-password" required minlength="6">
            </div>

            <div class="form-actions">
                <button type="submit">Restablecer contraseña</button>
                <a href="login.html">Volver al inicio</a>
            </div>

            <div id="reset-message" class="message" style="display:none;"></div>
        </form>
    </main>

    <footer>
        <p>&copy; 2025 Universidad Autonoma de Aguascalientes.</p>
    </footer>

    <script>
    // Helper: obtener parámetros de query
    function getQueryParams() {
        const params = {};
        const q = location.search.replace(/^[?]/, '').split('&').filter(Boolean);
        q.forEach(function(p) {
            const [k,v] = p.split('=');
            params[decodeURIComponent(k)] = decodeURIComponent((v||'').replace(/\+/g, ' '));
        });
        return params;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const params = getQueryParams();
        if (params.uid) document.getElementById('uid').value = params.uid;
        if (params.token) document.getElementById('token').value = params.token;

        document.getElementById('reset-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const uid = document.getElementById('uid').value || '';
            const token = document.getElementById('token').value || '';
            const newPass = document.getElementById('new-password').value || '';
            const confirm = document.getElementById('confirm-password').value || '';
            const msg = document.getElementById('reset-message');
            msg.style.display = 'none';

            if (!uid || !token) {
                msg.style.display = 'block';
                msg.textContent = 'Parámetro de token o usuario faltante en la URL.';
                return;
            }
            if (newPass.length < 6) {
                msg.style.display = 'block';
                msg.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                return;
            }
            if (newPass !== confirm) {
                msg.style.display = 'block';
                msg.textContent = 'Las contraseñas no coinciden.';
                return;
            }

            const form = new FormData();
            form.append('uid', uid);
            form.append('token', token);
            form.append('new_password', newPass);

            fetch('../php/reset_password.php', { method: 'POST', body: form })
                .then(async function(res) {
                    const text = await res.text();
                    try {
                        const j = JSON.parse(text);
                        msg.style.display = 'block';
                        msg.textContent = j.message || 'Operación completada.';
                        if (j.success) {
                            msg.classList.add('success');
                            // Opcional: redirigir al login después de 3s
                            setTimeout(function(){ location.href = 'login.html'; }, 3000);
                        } else {
                            msg.classList.remove('success');
                        }
                    } catch (e) {
                        msg.style.display = 'block';
                        msg.textContent = 'Respuesta inesperada del servidor.';
                    }
                }).catch(function(err) {
                    msg.style.display = 'block';
                    msg.textContent = 'Error de red: ' + (err.message || err);
                });
        });
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contraseña</title>
    <link rel="stylesheet" href="../CSS/style.css">
</head>
<body>
    <main class="recovery-container">
        <h2>Restablecer contraseña</h2>
        <p>Ingresa tu nueva contraseña.</p>
        <form id="reset-form">
            <div class="form-group">
                <label for="new-password">Nueva contraseña:</label>
                <input type="password" id="new-password" name="new_password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar contraseña:</label>
                <input type="password" id="confirm-password" required>
            </div>
            <div class="form-actions">
                <button type="submit">Restablecer contraseña</button>
            </div>
            <div id="reset-message" class="message" style="display:none;"></div>
        </form>
    </main>

    <script>
    // Leer token y uid del query string
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const uid = params.get('uid');

    if (!token || !uid) {
        document.getElementById('reset-message').style.display = 'block';
        document.getElementById('reset-message').textContent = 'Enlace inválido.';
    }

    document.getElementById('reset-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const p1 = document.getElementById('new-password').value;
        const p2 = document.getElementById('confirm-password').value;
        const msg = document.getElementById('reset-message');
        msg.style.display = 'block';
        if (p1 !== p2) {
            msg.textContent = 'Las contraseñas no coinciden.'; return;
        }
        const form = new FormData();
        form.append('uid', uid);
        form.append('token', token);
        form.append('new_password', p1);
        fetch('../php/reset_password.php', { method: 'POST', body: form })
            .then(r => r.json())
            .then(j => { msg.textContent = j.message; if (j.success) setTimeout(() => window.location.href = 'login.html', 2000); })
            .catch(() => { msg.textContent = 'Error de red.'; });
    });
    </script>
</body>
</html>
